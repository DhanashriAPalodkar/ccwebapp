{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{
      "keyPair":{
         "Type":"String"
      },
      "stackName":{
         "Type":"String"
      },
      "amiId":{
         "Type":"String"
      },
      "ApplicationName":{
         "Type":"String"
      },
      "s3Bucket":{
         "Type":"String"
      },
      "DBUsername":{
         "Default":"csye6225master",
         "Description":"The database admin account username",
         "Type":"String",
         "AllowedPattern":"[a-zA-Z][a-zA-Z0-9]*"
      },
      "DBPassword":{
         "Default":"csye6225password",
         "Description":"The database admin account password",
         "Type":"String",
         "AllowedPattern":"[a-zA-Z0-9]*"
      },
      "domainName":{
         "Type":"String"
      },
      "hostedZoneID":{
         "Type":"String"
      },
      "certificateARN":{
         "Type":"String"
      }
   },
   "Resources":{
      "loadBalancerSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Enable HTTP access via port 80, SSH access via port 22",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "VpcId":{
               "Fn::ImportValue":"csye6225-cf-vpc"
            }
         }
      },
      "webServerSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Enable HTTP access via port 80, SSH access via port 22",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "SourceSecurityGroupId":{
                     "Ref":"loadBalancerSecurityGroup"
                  }
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"8080",
                  "ToPort":"8080",
                  "SourceSecurityGroupId":{
                     "Ref":"loadBalancerSecurityGroup"
                  }
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "VpcId":{
               "Fn::ImportValue":"csye6225-cf-vpc"
            }
         },
         "DependsOn":"loadBalancerSecurityGroup"
      },
      "dbSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Security tag for web server",
            "SecurityGroupIngress":[
               {
                  "SourceSecurityGroupId":{
                     "Ref":"webServerSecurityGroup"
                  },
                  "FromPort":3306,
                  "IpProtocol":"tcp",
                  "ToPort":3306
               }
            ],
            "VpcId":{
               "Fn::ImportValue":"csye6225-cf-vpc"
            }
         }
      },
      "DBSubnetGroup":{
         "Type":"AWS::RDS::DBSubnetGroup",
         "Properties":{
            "DBSubnetGroupDescription":"DB Subnet Group",
            "DBSubnetGroupName":{
               "Fn::Join":[
                  "",
                  [
                     {
                        "Ref":"stackName"
                     },
                     "-csye6225-db-subnetgroup"
                  ]
               ]
            },
            "SubnetIds":[
               {
                  "Fn::ImportValue":"csye6225-cf-dbsubnet1"
               },
               {
                  "Fn::ImportValue":"csye6225-cf-dbsubnet2"
               }
            ]
         }
      },
      "ASGLaunchConfiguration":{
         "Type":"AWS::AutoScaling::LaunchConfiguration",
         "Properties":{
            "ImageId":{
               "Ref":"amiId"
            },
            "KeyName":{
               "Ref":"keyPair"
            },
            "InstanceType":"t2.micro",
            "IamInstanceProfile":{
               "Fn::ImportValue":"CodeDeployEC2InstanceProfile"
            },
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/sda1",
                  "Ebs":{
                     "VolumeType":"gp2",
                     "DeleteOnTermination":"true",
                     "VolumeSize":"20"
                  }
               }
            ],
            "SecurityGroups":[
               {
                  "Ref":"webServerSecurityGroup"
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "\n",
                     [
                        "#!/bin/bash -xe ",
                        "sudo su",
                        "echo '#!/bin/sh' >> /opt/tomcat/bin/setenv.sh",
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.url=\"jdbc:mysql://",
                                 {
                                    "Fn::GetAtt":[
                                       "RDSDB",
                                       "Endpoint.Address"
                                    ]
                                 },
                                 ":3306/csye6225\"\"'>> /opt/tomcat/bin/setenv.sh \n"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.profiles.active=cloud\"'>> /opt/tomcat/bin/setenv.sh\n"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.username=",
                                 {
                                    "Ref":"DBUsername"
                                 },
                                 "\"' >> /opt/tomcat/bin/setenv.sh\n"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo 'JAVA_OPTS=\"$JAVA_OPTS -Dspring.datasource.password=",
                                 {
                                    "Ref":"DBPassword"
                                 },
                                 "\"' >> /opt/tomcat/bin/setenv.sh\n"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo 'JAVA_OPTS=\"$JAVA_OPTS -Daws.s3.bucket.name=",
                                 {
                                    "Ref":"s3Bucket"
                                 },
                                 "\"' >> /opt/tomcat/bin/setenv.sh\n"
                              ]
                           ]
                        },
                        "chmod +x /opt/tomcat/bin/setenv.sh",
                        "systemctl stop tomcat.service",
                        "sleep 5",
                        "systemctl start tomcat.service",
                        "touch completed.txt"
                     ]
                  ]
               }
            }
         },
         "LaunchConfigurationName":"asg_launch_config",
         "AssociatePublicIpAddress":true
      },
      "WebServerGroup":{
         "Type":"AWS::AutoScaling::AutoScalingGroup",
         "Properties":{
            "AutoScalingGroupName":"WebServerGroup",
            "Cooldown":"30",
            "LaunchConfigurationName":{
               "Ref":"ASGLaunchConfiguration"
            },
            "MaxSize":"10",
            "MinSize":"3",
            "DesiredCapacity":"3",
            "HealthCheckType":"EC2",
            "HealthCheckGracePeriod":60,
            "Tags":[
               {
                  "Key":"codeDeployKey",
                  "Value":"codeDeployValue",
                  "PropagateAtLaunch":true
               }
            ],
            "TargetGroupARNs":[
               {
                  "Ref":"ALBTargetGroup"
               }
            ],
            "VPCZoneIdentifier":[
               {
                  "Fn::ImportValue":"csye6225-cf-websubnet1"
               },
               {
                  "Fn::ImportValue":"csye6225-cf-dbsubnet1"
               }
            ]
         }
      },
      "WebServerScaleUpPolicy":{
         "Type":"AWS::AutoScaling::ScalingPolicy",
         "Properties":{
            "AdjustmentType":"ChangeInCapacity",
            "AutoScalingGroupName":{
               "Ref":"WebServerGroup"
            },
            "Cooldown":"30",
            "ScalingAdjustment":"1"
         }
      },
      "WebServerScaleDownPolicy":{
         "Type":"AWS::AutoScaling::ScalingPolicy",
         "Properties":{
            "AdjustmentType":"ChangeInCapacity",
            "AutoScalingGroupName":{
               "Ref":"WebServerGroup"
            },
            "Cooldown":"60",
            "ScalingAdjustment":"-1"
         }
      },  
      "CPUAlarmHigh":{
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{
            "AlarmDescription":"Scale-up if CPU > 5% for 2 minutes",
            "MetricName":"CPUUtilization",
            "Namespace":"AWS/EC2",
            "Statistic":"Average",
            "Period":"60",
            "EvaluationPeriods":"2",
            "Threshold":"5",
            "AlarmActions":[
               {
                  "Ref":"WebServerScaleUpPolicy"
               }
            ],
            "Dimensions":[
               {
                  "Name":"AutoScalingGroupName",
                  "Value":{
                     "Ref":"WebServerGroup"
                  }
               }
            ],
            "ComparisonOperator":"GreaterThanThreshold",
            "Unit":"Percent"
         }
      },      
      "CPUAlarmLow":{
         "Type":"AWS::CloudWatch::Alarm",
         "Properties":{
            "AlarmDescription":"Scale-down if CPU < 3% for 2 minutes",
            "MetricName":"CPUUtilization",
            "Namespace":"AWS/EC2",
            "Statistic":"Average",
            "Period":"60",
            "EvaluationPeriods":"2",
            "Threshold":"3",
            "AlarmActions":[
               {
                  "Ref":"WebServerScaleDownPolicy"
               }
            ],
            "Dimensions":[
               {
                  "Name":"AutoScalingGroupName",
                  "Value":{
                     "Ref":"WebServerGroup"
                  }
               }
            ],
            "ComparisonOperator":"LessThanThreshold",
            "Unit":"Percent"
         }
      },  
      "ApplicationLoadBalancer":{
         "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
         "Properties":{
            "IpAddressType":"ipv4",
            "SecurityGroups":[
               {
                  "Ref":"loadBalancerSecurityGroup"
               }
            ],
            "Subnets":[
               {
                  "Fn::ImportValue":"csye6225-cf-websubnet1"
               },
               {
                  "Fn::ImportValue":"csye6225-cf-dbsubnet1"
               }
            ],
            "Name":"ApplicationLoadBalancer",
            "Scheme":"internet-facing",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"Loadbalancer"
               }
            ],
            "Type":"application"
         }
      },
      "ALBListenerService":{
         "Type":"AWS::ElasticLoadBalancingV2::Listener",
         "Properties":{
            "DefaultActions":[
               {
                  "Type":"forward",
                  "TargetGroupArn":{
                     "Ref":"ALBTargetGroup"
                  }
               }
            ],
            "LoadBalancerArn":{
               "Ref":"ApplicationLoadBalancer"
            },
            "Port":"443",
            "Protocol":"HTTPS",
            "Certificates":[
               {
                  "CertificateArn":{
                     "Ref":"certificateARN"
                  }
               }
            ]
         }
      },
      "ALBTargetGroup":{
         "Type":"AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties":{
            "HealthCheckIntervalSeconds":30,
            "HealthCheckPath":"/",
            "HealthCheckPort":"8080",
            "HealthCheckProtocol":"HTTP",
            "HealthCheckTimeoutSeconds":7,
            "HealthyThresholdCount":3,
            "Name":"ALBTargetGroup",
            "Port":8080,
            "Protocol":"HTTP",
            "TargetType":"instance",
            "UnhealthyThresholdCount":5,
            "VpcId":{
               "Fn::ImportValue":"csye6225-cf-vpc"
            },
            "Matcher":{
               "HttpCode":"401"
            }
         }
      },
      "DNSResourceRecord":{
         "Type":"AWS::Route53::RecordSet",
         "Properties":{
            "AliasTarget":{
               "HostedZoneId":{
                  "Fn::GetAtt":[
                     "ApplicationLoadBalancer",
                     "CanonicalHostedZoneID"
                  ]
               },
               "DNSName":{
                  "Fn::GetAtt":[
                     "ApplicationLoadBalancer",
                     "DNSName"
                  ]
               }
            },
            "HostedZoneId":{
               "Ref":"hostedZoneID"
            },
            "Name":{
               "Ref":"domainName"
            },
            "Type":"A"
         }
      },                                                  
      "DynamoDBTable":{
         "Type":"AWS::DynamoDB::Table",
         "Properties":{
            "AttributeDefinitions":[
               {
                  "AttributeName":"id",
                  "AttributeType":"S"
               }
            ],
            "KeySchema":[
               {
                  "AttributeName":"id",
                  "KeyType":"HASH"
               }
            ],
            "ProvisionedThroughput":{
               "ReadCapacityUnits":2,
               "WriteCapacityUnits":2
            },
            "TableName":"csye6225",
            "TimeToLiveSpecification":{
               "AttributeName":"expiration",
               "Enabled":true
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"csye6225DynamoDB"
               }
            ]
         }
      },
      "RDSDB":{
         "Type":"AWS::RDS::DBInstance",
         "Properties":{
            "AllocatedStorage":"5",
            "DBInstanceClass":"db.t2.micro",
            "DBInstanceIdentifier":"csye6225-summer2019",
            "DBSubnetGroupName":{
               "Ref":"DBSubnetGroup"
            },
            "DBName":"csye6225",
            "Engine":"mysql",
            "EngineVersion":"8.0.15",
            "MasterUsername":{
               "Ref":"DBUsername"
            },
            "MasterUserPassword":{
               "Ref":"DBPassword"
            },
            "MultiAZ":"false",
            "PubliclyAccessible":"true",
            "VPCSecurityGroups":[
               {
                  "Ref":"dbSecurityGroup"
               }
            ]
         }
      },
      "CodeDeployApplication":{
         "Type":"AWS::CodeDeploy::Application",
         "Properties":{
            "ApplicationName":{
               "Ref":"ApplicationName"
            },
            "ComputePlatform":"Server"
         }
      },
      "CodeDeployDeploymentGroup":{
         "Type":"AWS::CodeDeploy::DeploymentGroup",
         "DependsOn":["WebServerGroup","ALBTargetGroup","CodeDeployApplication"],
         "Properties":{
            "ApplicationName":{
               "Ref":"CodeDeployApplication"
            },
            "DeploymentGroupName":"csye6225-webapp-deployment",
            "DeploymentStyle":{
               "DeploymentOption":"WITH_TRAFFIC_CONTROL",
               "DeploymentType":"IN_PLACE"
            },
            "AutoRollbackConfiguration":{
               "Enabled":"true",
               "Events":[
                  "DEPLOYMENT_FAILURE"
               ]
            },
            "DeploymentConfigName":"CodeDeployDefault.AllAtOnce",
            "ServiceRoleArn":{
               "Fn::ImportValue":"CodeDeployServiceRoleOutput"
            },
            "AutoScalingGroups":[
               {
                  "Ref":"WebServerGroup"
               }
            ],
            "LoadBalancerInfo":{
               "TargetGroupInfoList":[
                  {
                     "Name":{
                        "Fn::GetAtt":[
                           "ALBTargetGroup",
                           "TargetGroupName"
                        ]
                     }
                  }
               ]
            }                                 
         }
      }
   },
   "Outputs":{
      "loadBalancer":{
         "Description":"Application LoadBalancer",
         "Value":{
            "Ref":"ApplicationLoadBalancer"
         },
         "Export":{
            "Name":"csye6225-load-balancer"
         }
      }
   }   
}